<html>
<head>
<style>
.text-right {
  text-align: right;
}

body {
  background-color: #13223c;
  font: impact;
  color: rgba(255, 255, 255, 0.4);
}

.error {
  color:#e53b51;
  display: inline-block;
  visibility: hidden;
}

.half-width {
  width: 50%;
  float: left;
}

textarea {
  width: 50%;
  height: 60%;
  display: inline-block;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.spinner {
  position: absolute;
  left: 50%;
  top: 50%;
  height:60px;
  width:60px;
  margin:0px auto;
  -webkit-animation: rotation .6s infinite linear;
  -moz-animation: rotation .6s infinite linear;
  -o-animation: rotation .6s infinite linear;
  animation: rotation .6s infinite linear;
  border-left:6px solid rgba(0,174,239,.15);
  border-right:6px solid rgba(0,174,239,.15);
  border-bottom:6px solid rgba(0,174,239,.15);
  border-top:6px solid rgba(0,174,239,.8);
  border-radius:100%;
  opacity: .5;
}

@-webkit-keyframes rotation {
  from {-webkit-transform: rotate(0deg);}
  to {-webkit-transform: rotate(359deg);}
}
@-moz-keyframes rotation {
  from {-moz-transform: rotate(0deg);}
  to {-moz-transform: rotate(359deg);}
}
@-o-keyframes rotation {
  from {-o-transform: rotate(0deg);}
  to {-o-transform: rotate(359deg);}
}
@keyframes rotation {
  from {transform: rotate(0deg);}
  to {transform: rotate(359deg);}
}


#spinnerBox {
  visibility: hidden;
  position: absolute;
  top:0;
  background-color: #ffd600;
  width: 100%;
  height: 100%;
}

#nonce, #gasPrice, #gasLimit {
  width: 300px;
}

#submitButton{
  color: #fff;
  background: #337ab7;
  border-color: #337ab7;
  display: block;
  padding: 0 1.5rem;
  letter-spacing: 0.3px;
  font-family: "Raleway", sans-serif;
  font-weight: 700;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 1rem;
  text-align: center;
  font-size: 11px;
  line-height: 38px;
  letter-spacing: .1rem;
  text-transform: uppercase;
  white-space: nowrap;
  border-radius: 4px;
}

input {
  color: #fff;
  text-transform: lowercase;
  margin: auto;
  font-weight: bold;
  width: 100%;
  font-family: "Raleway", sans-serif;
  font-size: 1.2rem;
  background-color: #162744;
  border: 0px;
  border-bottom: solid 2px rgba(255, 255, 255, 0.4);
  padding: 6px 10px;
  margin-bottom: 1.5rem;
}

#prvkey {
  margin: 0px;
}

#container {
  margin: 15px;
}

#solidity-compiler {
  width: 70%;
  display: inline-block;
  float: left;
}

#account-info {
  width: 30%;
  display: inline-block;
  float: left;
  word-wrap: break-word;
}

#address,#nonce {
  color: #ffd600;;
  text-transform: lowercase;
  margin: auto;
  font-weight: bold;
  width: 100%;
  font-family: "Raleway", sans-serif;
  font-size: 1.2rem;
  padding: 6px 10px;
  margin-bottom: 1.5rem;
}

</style>


<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="/includetransaction/pushtx.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

<script>

var compilerData = null;

function checkResults(response) {
  var x = response.replace(/.*=/, "");
  //window.setInterval("checkResult(" + ")", 1000);

  $.get("/transactionResult/" + x)
    .done(function(data) {
      spinnerBox.style.visibility = 'hidden';
      var responseText = "";
      for(var i = 0; i < data.length; i++) {
        responseText = responseText + data[i].message + "\n";
      }
      $('#output').val(responseText);
      alert('Transaction has been submitted successfully!');
      loadAccountInfo();

      var form = document.createElement("form");
      form.method = 'post';
      form.action = '/afterSubmission.html';
      var input = document.createElement('input');
      input.type = "text";
      input.name = "abi";
      input.value = JSON.stringify(compilerData.abis[0].abi);
      form.appendChild(input);

      var input2 = document.createElement('input');
      input2.type = "text";
      input2.name = "contractAddress";
      input2.value = util.generateAddress(address.innerHTML, parseInt(nonce.value)).toString('hex');
      form.appendChild(input2);

      var input3 = document.createElement('input');
      input3.type = "text";
      input3.name = "transactionHash";
      input3.value = x;
      form.appendChild(input3);

      form.submit();
    })
    .fail(function(jqXHR, textStatus, errorThrown) {
      $('#output').val("ERROR!\n" + textStatus);
    });
}

function submitTransaction() {
  if (compilerData.error) {
    alert("You can't submit the contract until it has succesfully compiled");
    return;
  }

  if (compilerData.contracts.length == 0) {
    alert("Error!  There is no contract to submit.");
    return;
  }

  if (compilerData.contracts.length != 1) {
    alert("Sorry, submitting more than one contract not currently supported!");
    return;
  }

  spinnerBox.style.visibility = "visible";
  var url = 'http://stablenet.blockapps.net/includetransaction';
  var value =  0;

  api.pushTX(
    parseInt($('#nonce').html()),
    parseInt($('#gasPrice').val()),
    parseInt($('#gasLimit').val()),
    undefined,value,
    compilerData.contracts[0].bin,
    $('#prvkey').val(),
    url, checkResults
  );

}

function compile() {
  //oReq.setRequestHeader("Content-length", params.length);
  //oReq.setRequestHeader("Connection", "close");
  $.ajax({
    type: "POST",
    url: "/solc",
    data: "src=" + encodeURIComponent(input.value),
    contentType: "application/x-www-form-urlencoded"
  })
  .done(function(data, textStatus, jqXHR) {
    compilerData = JSON.parse(data);
    if (compilerData.error != null) {
      output.style.color = 'red';
      submitButton.disabled = true;
      $('#output').val(compilerData.error);
    }
    else {
      output.style.color = 'black';
      submitButton.disabled = false;
      if (compilerData.contracts.length == 0)
        $('#output').val("[Blank]");
      else
        $('#output').val("Compiled Binary:\n\n" + compilerData.contracts[0].bin);
    }
  })
  .fail(function(jqXHR, textStatus, errorThrown) {
    $('#output').val("ERROR!\n" + textStatus);
  });
}

function loadAccountInfo() {
  address.innerHTML = ''
  if (!$('#prvkey').val().match(/^[a-f0-9]{64}$/i)) {
    invalidPrvKeyWarning.style.visibility="visible";
    return;
  }

  $('#address').html(util.privateToAddress(new Buffer($('#prvkey').val(), 'hex')).toString('hex'));
  $.get("/query/account?address=" + $('#address').html())
    .done(function(data, textStatus, jqXHR) {
      invalidPrvKeyWarning.style.visibility="hidden";
      if (data.length >= 1) {
        $('#nonce').html(data[data.length - 1].nonce);
        if (data.length > 1) alert("error! too many values in account query, just using the last value.");
      }
      else
        $('#nonce').html("0");
      })
    .fail(function() {
      //returned an error, but no biggie, could just be a malformed form item, etc.
        //output.value = "ERROR in fetching address info!\n" + this.responseText;
    });
}
</script>

</head>
<body>
  <h1>Type your Solidity source code in below</h1>
  <div id="container">
    <div id="solidity-compiler">
      <textarea class="half-width" id="input" onchange="compile();" onkeyup="compile()">
        contract NameCoin {

          struct Item {
            address owner;
            uint value;
          }

          address gAddress;
          uint gValue;
          mapping (uint => Item) registry;

          function NameCoin() {
            gAddress = msg.sender;
          }

          function register(uint key) {
            if (registry[key].owner == 0) {
              registry[key].owner = msg.sender;
            }
          }

          function transferOwnership(uint key, address newOwner) {
            if (registry[key].owner == msg.sender) {
              registry[key].owner = newOwner;
            }
          }

          function setValue(uint key, uint newValue) {
            if (registry[key].owner == msg.sender) {
              registry[key].value = newValue;
            }
          }

          function getValue(uint key) constant returns (uint value) {
            gValue = registry[key].value;
          }

          function getOwner(uint key) constant returns (address owner) {
            gAddress = registry[key].owner;
          }
        }
      </textarea>
      <textarea class="half-width" id="output" readonly="true"></textarea>
    </div>
    <div id="account-info">
      <label>Private Key:</label>
      <input id="prvkey"
      value="1dd885a423f4e212740f116afa66d40aafdbb3a381079150371801871d9ea281"
      onkeyup="loadAccountInfo();" />
      <p id="invalidPrvKeyWarning" class="error">Invalid Private Key</p>
    </br>
    <label for="address">Address:</label>
    <p id="address"> </p>
    <button id="submitButton" onclick="submitTransaction()">Press here to submit transaction</button>
    <details>
      <summary>Advanced Options</summary>
      <table>
        <tr>
          <td class="text-right"><label for="gasLimit">Gas Limit:</label></td>
          <td><input id="gasLimit" value="1000000"/></td>
        </tr>
        <tr>
          <td class="text-right"><label for="gasPrice">Gas Price:</label></td>
          <td><input id="gasPrice" value="100000"/></td>
        </tr>
        <tr>
          <td class="text-right"><label for="nonce">Nonce:</label></td>
          <td><span id="nonce" value="0"></span></td>
        </tr>
      </table>
    </details>
  </div>
</div>

<div id="spinnerBox">
  <div class="spinner" />
</div>


<script>
compile();
loadAccountInfo();
input.selectionStart = 10;
input.selectionEnd = 22;
</script>
</body>
</html>
